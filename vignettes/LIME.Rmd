---
title: 'LIME: An R package for simulation and estimation using length data to account for variable fishing mortality and recruitment'
author: "Merrill Rudd"
date: '`r Sys.Date()`'
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{LIME: An R package for simulation andestimation using length data to account for variable fishing mortality and recruitment}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Introduction
This package contains functions to run the Length-based Integrated Mixed Effects (LIME) fisheries stock assessment method. The LIME package can be used in two ways: 1) simulating the expected age-structured population dynamics, length composition, catch data, and an abundance index using LIME and 2) fitting to empirical length data at a minimum and any available catch and/or abundance index data to provide an estimate of the spawning potential ratio (SPR).

LIME has been developed for data-limited fisheries, where few data are available other than a representative sample of the size structure of the vulnerable portion of the population (i.e., the catch) and an understanding of the life history of the species. LIME relaxes the equilibrium assumptions of other length-based methods by estimating annual fishing mortality and recruitment variation (among other parameters), deriving annual recruitment as a random effect.

See Rudd and Thorson (2017) in the reference list for full details of the model, including simulation testing to evaluate performance across life history types, population variability scenarios, and data availability scenarios, as well as violations of the model assumptions.  

## Bug Reports
Please alert me to any bugs or issues by using [GitHub](https://github.com/merrillrudd/LIME/issues).

Comments and suggestions for additional features are welcome and we can discuss via email  at mbrudd@uw.edu.

Finally, please make sure you understand the data and the biological parameters (and how the model treats these) and critically evaluate any output of LIME. 

# First Steps

## Installing the Package
1) `devtools`: You can install the development version of the package from GitHub using the `devtools` package:
```{r, eval=FALSE}
install.packages("devtools", repos='http://cran.us.r-project.org')
```

2) Follow the steps to install TMB:

Windows: https://github.com/kaskr/adcomp/wiki/Windows-installation

Linux: https://github.com/kaskr/adcomp (See README)

Mac: should be the same as Linux, please see contact info under Bug Reports if that doesn't work.

3) Install required package `TMBhelper`:
```{r, eval=FALSE}
devtools::install_github("kaskr/TMB_contrib_R/TMBhelper")
```


4) Install LIME:
```{r, eval=FALSE}
devtools::install_github("merrillrudd/LIME", build_vignettes=TRUE)
```

The installation may produce error messages requiring other packages. You can download those from CRAN if they are not automatically downloaded in the LIME installation process, and then start from the step that produced the error. Again, please use the contact info in Bug Reports if this doesn't work, as you may have discovered a new installation error... congratulations!

## Load the Package
```{r, message=FALSE}
library(LIME)
```

# Simulation
The LIME package can be used to generate the expected size composition, other age-structured outputs (e.g. abundance-at-age, catch-at-age, annual recruitment), SPR, and MSY for a given set of biological parameters and fishing mortality and recruitment patterns.

## Specify biological inputs and starting values
The LIME package simulation and estimation features require the biological inputs and starting values for selectivity parameters in a list. Using `create_lh_list` will make sure all required elements are included within the list and in the required format. The `create_lh_list` function requires inputs for some parameters and includes default values for others.

### Minimum inputs for `create_lh_list`

The user is required to input the following parameters to `create_lh_list` for simulation and estimation:

 **Minium inputs: Biology**

 - von Bertalanffy asymptotic length (`linf`)
 - von Bertalanffy growth coefficient (`vbk`)
 - Annual natural mortality (`M`)
 - Length-weight scaling parameter (`lwa`)
 - Length-weight allometric parameter (`lwb`)
 - Length or age at 50% maturity (`M50`)
 - Whether `M50` input is in "length" or "age" (`maturity_input`)
 
 **Minimum inputs: Exploitation**

 - Length at 50% selectivity (`S50`)
 - Whether `S50` input is in "length" or "age" (`selex_input`)
 
 **Assumptions using the default settings**

 - Width of the length classes (`binwidth`) equal to 1
 - von Bertalanffy length at age=0 (`t0`) equal to -0.01
 - Selectivity is assumed to follow a logistic function.
 - If `M95` and `S95` are unspecified, their defaults are `NULL` and we assume one-parameter logistic maturity and/or selectivity. This results in close to knife-edge maturity or selectivity. 
 
### Other inputs for `create_lh_list`

 **Other inputs: Biology**

 - Length or age at 95% maturity (`M95`): Default=`NULL` for one-parameter logistic maturity; specifying `M95` will use two-parameter logistic maturity curve. It is assumed `M95` should be input as length if `M50` is length, same for age.
 - Length at age=0 (`t0`): Default=-0.01, should be adjusted based on local studies or meta-analysis.
 - Equilibrium recruitment (`R0`): Default=1.0. Changing `R0` will change the scale of the population size. It is recommended to set an initial value of `R0` more appropriate to the expected population size if using catch data to estimate population size with LIME. 
 - Steepness (`h`): Default=1.0 such that the expected recruitment calculated in the Beverton-Holt stock-recruit curve is not affected by the level of spawning biomass. Setting `h` below 1.0 will lead to the expected annual recruitment as a function of the spawning biomass. LIME will still calculate recruitment deviates around this expected value of annual recruitment. 
 - Maximum age (`AgeMax`): Default= the age at which 1% of the population is still alive based on the specified natural mortality rate `M`. This age can be adjusted based on local evidence of maximum age.
 - Recruitment autocorrelation (`rho`): Used in simulation only. Default=0 (no recruitment autocorrelation). Changing the value of `rho` will add autocorrelation to the generated recruitment time series for a simulation study. 
 
 **Other inputs: Exploitation**

 - Length or age at 95% selectivity (`S95`): Default=`NULL` for one-parameter logistic selectivity; specifying `S95` will use two-parameter logistic selectivity curve. It is assumed `S95` should be input as length if `S50` is length, same for age.
 - Selectivity function (`selex_type`): Default=`logistic` using a one-parameter logistic selectivity curve if `S95` is not specified, or a two-parameter logistic curve if `S95` is specified. Alternate option=`dome` to generate a population exploited based on a dome-shaped selectivity curve. Dome-shaped selectivity cannot currently be estimated in LIME, but specifying dome-shaped selectivity in the `create_lh_list` function can generate an assumed dome-shaped curve to be fixed when using LIME for estimation. 
 - Dome-shaped selectivity right-hand standard deviation (`dome_sd`): Default=`NULL` for logistic selectivity, must be specified if `selex_type`=`dome`. The standard deviation of the normal distribution for the right side of the selectivity curve (after the logistic curve specified reaches 100% selectivity).
 - Catchability coefficient (`qcoef`): Estimated when using an abundance index, default=1e-5, starting value should be adjusted to a reasonable number based on the abundance index and starting value for the scaling parameter `R0`.
 - Dirichlet-multinomial parameter (`theta`): Default=10, a relatively large number coinciding with no variance inflation where the effective sample size will approach the input sample size (Thorson et al. 2017)
 - Number of seasons in a year (`nseasons`): Default=1 for annual length composition data and annual growth and mortality parameters. For short-lived species, it is helpful to use a shorter-than-annual time step to account for the growth of short-lived fish during one year, if length data is collected on time steps less than one year (e.g. month, `nseasons`=12).

 **Other inputs: Variation**

 - Coefficient of variation around the growth curve (`CVlen`): Default=0.1; Should be adjusted based on the expected variability in the age-length curve.
 - Recruitment standard deviation (`SigmaR`): Default=0.737, the median across all fish species (Thorson et al. 2014); Used for generating recruitment deviates in the simulation or as a starting value for its estimation using LIME. 
 - Fishing mortality standard deviation (`SigmaF`): Default=0.2; Used for generating fishing mortality deviates in the simulation or as the standard deviation of the fishing mortality penalty when estimating annual fishing mortality using LIME. 
 - Catch standard deviation (`SigmaC`): Default=0.2; Used as the fixed standard deviation in the lognormal likelihood when fitting LIME to catch data.
 - Index standard deviation (`SigmaI`): Default=0.2; Used as the fixed standard deviation in the lognormal likelihood when fitting LIME to index data.


Now let's populate the `create_lh_list` function with example values.
```{r}
lh <- create_lh_list(vbk=0.21,
                     linf=65,
                     t0=-0.01,
                     lwa=0.0245,
                     lwb=2.79,
                     M=0.27,
                     M50=34,
                     M95=NULL,
                     maturity_input="length",
                     S50=20,
                     S95=26,
                     selex_input="length",
                     binwidth=1,
                     CVlen=0.1,
                     SigmaR=0.737,
                     SigmaF=0.2,
                     R0=1,
                     rho=0.43,
                     nseasons=1)
```

### Plot the biological and selectivity inputs
And then check out the biological parameters and selectivity we've created. Note that even though we input maturity and selectivity by length, `create_lh_list` converts to age and outputs both age (`lh$S_a`) and length (`lh$S_l`).

```{r, fig.height=6, fig.width=8, echo=FALSE, fig.cap="Example length-at-age, weight-at-age, maturity-at-length, and selectivity-at-length."}
par(mfrow=c(2,2), mar=c(4,4,3,1))
plot(lh$L_a, type="l", lwd=4, xlab="Age", ylab="Length (cm)")
plot(lh$W_a, type="l", lwd=4, xlab="Age", ylab="Weight (g)")
plot(lh$Mat_l, type="l", lwd=4, xlab="Length (cm)", ylab="Proportion mature")
plot(lh$S_l, type="l", lwd=4, xlab="Length (cm)", ylab="Proportion selected to gear")
```

## Generating data from the simulation model

Using the life history list output from `create_lh_list`, we can simulate a population and generate data. 

The `generate_data` function has several settings for which the user is required to input a value:

 - `modpath`: model path for saving simulated populations; can set as `NULL` to run within the R environment only without saving locally.
 - `itervec`: vector of iterations of simulated data; can be 1 to run only one iteration, or 1:100 to run 100 iterations of simulated populations.
 - `lh`: life history list, output from `create_lh_list`.
 - `Fdynamics`: Pattern for fishing mortality dynamics; options include `Constant`, `Ramp`, `Increasing`, `None`, or `Endogenous`.
 - `Rdynamics`: Pattern for recruitment dynamics; options include `Constant`, `AR` (for autocorrelated recruitment), `Pulsed`, `Pulsed_up`, or `BH` (for Beverton-Holt stock-recruit relationship).
 - `Nyears`: number of years for your simulated population.
 - `Nyears_comp`: number of years to generate length data; e.g. if 10 years and `Nyears` is 20 years, will be the last 10 years in the 20 year time series.
 - `comp_sample`: nominal sample size of length data annually; e.g. 200 length measurements collected annually.
 - `init_depl`: initial depletion, or the proportion of the unfished population biomass in the first year of the population to be modeled. Specifying a single value indicates the initial depletion (e.g. 0.5) or two values indicates the lower and upper bounds of a uniform distribution for which the population simulation will randomly draw a depletion value (e.g. c(0.1,0.9)).
 -  `seed`: set a seed for random numbers for generating process deviations.
 
There are also several other settings not required but may be useful:

 - `rewrite`: default=TRUE to always re-simulated data. `rewrite`=FALSE may be useful to only simulate a new population if the `True.rds` output file already exists in the folder.
 - `derive_quants`: default=FALSE to save time, changing this argument to TRUE will calculate MSY-based reference points. 
 - `pool`: default=TRUE, meaning that if the number of seasons per year as specified in the `create_lh_list` function is more than 1, the length composition data collected in each time set is pooled together annually. `pool`=FALSE would mean the generated length composition data is on a time step shorter than 1 year (e.g. monthly if `nseasons`=12). The total sample size for the year will still be equal to `comp_sample`.
 - `mismatch`: default=FALSE, indicating that the length data, catch, and abundance index are all generated from the same years. `mismatch`=FALSE forces the length data to be collected in separate years from the catch and abundance index, overlapping only 1 year.

Now let's use `generate_data` to simulate 1 example population (itervec=1) to generate length, catch, and an abundance index. We won't specify a `modpath` so the simulated population will just be used locally in this vignette.
```{r, echo=FALSE}
set.seed(143)
```
```{r}
true <- generate_data(modpath=NULL,
                      itervec=1,
                      lh=lh,
                      Fdynamics="Ramp",
                      Rdynamics="AR",
                      Nyears=20,
                      Nyears_comp=20,
                      comp_sample=200,
                      init_depl=0.8,
                      seed=1)
```

### Plot the simulated population

```{r, fig.width=10, fig.height=6, echo=FALSE, fig.cap="True population: fishing mortality ramped (increasing then decreasing), autocorrelated recruitment, spawning potential ratio (SPR), mean length, spawning biomass, and relative spawning biomass."}
par(mfrow=c(2,3))
plot(true$F_t, type="l", lwd=4, xlab="Year", ylab="Fishing mortality", ylim=c(0,max(true$F_t)*1.1), xaxs="i", yaxs="i", cex.axis=1.5, cex.lab=1.5)
plot(true$R_t, type="l", lwd=4, xlab="Year", ylab="Recruitment", ylim=c(0,max(true$R_t)*1.1), xaxs="i", yaxs="i", cex.axis=1.5, cex.lab=1.5)
plot(true$SPR_t, type="l", lwd=4, xlab="Year", ylab="SPR", ylim=c(0,1), xaxs="i", yaxs="i", cex.axis=1.5, cex.lab=1.5)
plot(true$ML_t, type="l", lwd=4, xlab="Year", ylab="Mean length", ylim=c(0,max(true$ML_t)*1.1), xaxs="i", yaxs="i", cex.axis=1.5, cex.lab=1.5)
plot(true$SB_t, type="l", lwd=4, xlab="Year", ylab="Spawning biomass", ylim=c(0,max(true$SB_t)*1.1), xaxs="i", yaxs="i", cex.axis=1.5, cex.lab=1.5)
plot(true$D_t, type="l", lwd=4, xlab="Year", ylab="Relative spawning biomass", ylim=c(0,max(true$D_t)*1.1), xaxs="i", yaxs="i", cex.axis=1.5, cex.lab=1.5)
```

### Plot the generated data

Each panel of length data is labeled with the year (1-20).

```{r, fig.height=6, fig.width=8, echo=FALSE, fig.cap="Generated length composition data, labeled by years 1-20."}
plot_LCfits(Inputs=list("LF"=true$LF))
```

```{r, fig.height=3, fig.width=10, echo=FALSE, fig.cap="Generated catch and abundance index over time."}
par(mfrow=c(1,2))
plot(true$Cw_t, type="l", lwd=4, xlab="Year", ylab="Catch (g)", ylim=c(0,max(true$Cw_t)*1.1), xaxs="i", yaxs="i", cex.axis=1.5, cex.lab=1.5)
plot(true$I_t, type="l", lwd=4, xlab="Year", ylab="Abundance index", ylim=c(0,max(true$I_t)*1.1), xaxs="i", yaxs="i", cex.axis=1.5, cex.lab=1.5)
```

# Estimation

Using LIME for estimation requires three vital steps:

 1. Setup data correctly
 2. Run the LIME model using TMB
 3. Check convergence and plot output
 4. Run sensitivities

## Data setup

It is very important that the data are set up correctly for the LIME estimation to run.

### Length data

A matrix with the time step (e.g. year) along the rows and length bins along the columns. 

 - Rows should be named with the year names. Only years with length data should be included. Years can be in true years (1998-2017) or indexed years (1-20) as long as there is consistency between items in the data list (see "Input List" below).
 - Columns should be named with the upper length bins. Columns should range from the first possible length bin (e.g. 1 for 1-cm length bins) to the last observed length bin. If there are no observations until 30cm, add a matrix of zeros for lengths 1,2,3,...29cm.  If the last observed length bin is less than 1.5 times the asymptotic length (linf), LIME will internally add a matrix of zeros to be able to account for potentially larger fish than were observed.
 
```{r}
## years with length data -- rename with your own years with length data
length_years <- rownames(true$LF)

## length bins -- rename with your upper length bins
length_bins <- colnames(true$LF)

## matrix with length frequency data
LF <- true$LF

## set rownames as years
rownames(LF) <- length_years

## set colnames as length bins
colnames(LF) <- length_bins

## first six years of length data
head(LF)
```

It is possible length data exist for 10 years only, but either 1) catch or abundance index data are available for years prior to length data or 2) the first few years of length data hold information on recruitment from years prior. 

In the scenario that you have ten years of length data but want to model over 20 years, just make sure the years of length data are labeled with the correct year in terms of the overall model:
```{r}
## years with length data, shortened
years_short <- 11:20

LF_short <- LF[years_short,]
rownames(LF_short) <- years_short

LF_short
```

### Catch and index data

Vectors with each observation named with the time step (e.g. year) it was observed. Years can be in true years (1998-2017) or indexed years (1-20) as long as there is consistency between items in the data list (see "Input List" below).

Setup for the catch data:
```{r}
## catch years
catch_years <- names(true$Cw_t)

## catch in weight
C_t <- true$Cw_t
names(C_t) <- catch_years

C_t

```

Same setup for the abundance index:
```{r}
## index years
index_years <- names(true$I_t)

## catch in weight
I_t <- true$I_t
names(I_t) <- index_years

I_t

```


### Input list

LIME requires data in an list form, with a minimum:

 - `years`: the total, inclusive years to model. 
    - If length data is available for years 1-5 and 10-20, `years` should be a vector 1-20. 
    - Years can be in true years (1998-2017) or indexed years (1-20) as long as there is consistency between the length, catch, and/or index data. For example, if length data years are labeled 1998-2017, `years` should be 1998-2017 (or may start before 1998 if length data are informative for a few years prior to the first year of data). 
    
 - `LF`: the length frequency matrix. See "Length data" section above for formatting details.
    - Rows labeled with years.
    - Columns labeled with upper length bins.
 
With the minium inputs, the data list should look like:  
```{r}
## years with length data, make sure they are numbers and not characters
length_years <- as.numeric(rownames(LF))

## total years
total_years <- min(length_years):max(length_years)

data_list <- list("years"=total_years, "LF"=LF)
```


If catch and/or an abundance index are available, these should also be included in the data input list. See "Catch and index data" section above for formatting details. 
 
 - `C_t`: catch data, in numbers or weight (to be specified later)
 - `I_t`: abundance index.
 

```{r}
## years with catch data, make sure they are numbers and not characters
catch_years <- as.numeric(names(C_t))

## years with index data, make sure they are numbers and not characters
index_years <- as.numeric(names(I_t))

## find minimum year across all data types
min_yr <- min(c(length_years, catch_years, index_years))

## find maximum year across all data types
max_yr <- max(c(length_years, catch_years, index_years))

total_years <- min_yr:max_yr

data_list <- list("years"=total_years, "LF"=LF, "C_t"=C_t, "I_t"=I_t)
data_list
```

Remember to plot your data to make sure they look right. See above section "Plot generated data" where we already checked the generated data used for the vignette.

## Run LIME

Now we can use `run_LIME` to run the LIME assessment. LIME uses Template Model Builder (TMB) to calculate recruitment deviations as random effects and standard errors (Kristensen et al. 2016). However, the LIME package has the model pre-compiled, so all you really need are the TMB and TMBhelper packages downloaded and the `run_LIME` function. 

The function `run_LIME` has several required inputs:

 - `modpath`: model path for saving LIME output; can set as `NULL` to run within the R environment only without saving locally.
 - `lh`: life history list, output from `create_lh_list`.
 - `input_data`: list of data inputs, output above called `data_list`.
 - `est_sigma`: vector of variance parameters to estimate, must match parameter names. Estimate recruitment standard deviation with `log_sigma_R`. Another desired option may be including the coefficient of variation around the growth curve, `log_CV_L`. Other options include the catch or index standard deviations: `log_sigma_C`, `log_sigma_I`. Concatenate to estimate multiple variance parameters: e.g. c(`log_sigma_R`,`log_CV_L`). If not included in `est_sigma`, parameter will be fixed at the starting value set in `create_lh_list`.
 - `data_avail`: Types of data included, must at least include "LC"" as length data is the minimum data input. May also include "Catch" or "Index" if included, separated by an underscore, e.g. "LC", "Catch_LC", "Index_LC", or "Index_Catch_LC".
 
There are many other settings and tools included as arguments to `run_LIME`:

**Fixing parameters**

 - `fix_param`: default=FALSE, or can specify a non-time-varying parameter name (must match name from model). Many parameters are automatically fixed unless specific data scenarios arise. Non-time-varying parameters that could be fixed using this argument include:
   - `log_q_I`: log catchability coefficient, automatically fixed to starting value from `create_lh_list` unless using an abundance index.
   - `beta`: log equilibrium recruitment, automatically fixed to starting value from `create_lh_list` unless using catch data.
   - `logS50`: log length at 50% selectivity, automatically estimated unless specified in `fix_param`.
   - `logSdelta`: log difference between length at 95% and 50% selectivity, automatically estimated unless specified in `fix_param`.
   - `log_theta`: log Dirichlet-multinomial parameter related to effective sample size, automatically estimated unless specified in `fix_param`.
 - `fix_param_t`: default=FALSE, or can fix some time-varying values with the name as the first item in the list and the years as a vector in the second item of the list.
   - to fix years 1-10 of fishing mortality rates: `fix_param_t`=list(param="log_F_t_input", years=1:10)
   - to fix years 1-10 of recruitment deviations: `fix_param_t`=list(param="Nu_input", years=1:10)
 - `S_l_input`: default=-1 to estimate selectivity parameters or use input values. Fix the selectivity curve to specific values by inputting a vector of selectivity-at-length. The objective of this setting is to explore the impact of dome-shaped selectivity or exploring other shapes besides the one- or two-parameter logistic curves.
 - `randomR`: default=TRUE to derive recruitment deviations as random effects. Change to FALSE to turn off random effect on recruitment.
 - `param_adjust`: vector of parameter names, as a simple way to change the starting or input values for some parameters than creating a new list with `create_lh_list`
   - full list includes: `SigmaR`, `SigmaF`, `SigmaC`, `SigmaI`, `CVlen`, `M`, `linf`, `vbk`, `ML50`. 
   - Other parameters require new life history list with `create_lh_list`
 - `val_adjust`: adjusted values in the order listed by parameter names in `param_adjust`
 
**Other settings**

 - `rewrite`: default=TRUE to run LIME assessment, change to FALSE to avoid re-running LIME if output already exists in the directory.
 - `C_opt`: default=0 when not including catch data. 1= input catch in numbers, 2= input catch in biomass.
 - `newtonsteps`: specify number of newton steps to take after optimization; default=3 to help with optimization; 0 will turn this feature off.
 - `F_up`: upper bound of fishing mortality parameters, default=10
 - `S50_up`: upper bound of length at 50% selectivity, default=NULL
 - `LFdist`: default=1 to use dirichlet-multinomial likelihood function to fit length comp data, other option 0= multinomial likelihood using nominal sample size of length data.
 - `derive_quants`: default=FALSE due to longer run time, can set to TRUE to output additional derived quantities, including MSY-based reference points when catch data included.
 - `theta_type`: default=1 to estimate single theta related to effective sample size for all years of length comp. 0=estimate annual theta for each year of length data.
 - `Fpen`: penalty on fishing mortality; default=1 ON, 0=OFF
 - `SigRpen`: penalty on recruitment standard deviation; default=1 ON, 0=OFF


**Settings related to simulation**

 - `f_true`: default=FALSE for starting values of fishing mortality rates at 1.0. change to TRUE to start at the true values from the simulation.
 - `itervec`: default=NULL, for use in simulation study to run multiple iterations within the same set of model run settings.
 - `simulation`: default=FALSE, change to TRUE if using LIME in the context of a simulation study, to require `itervec` specification.


Here is an example to run LIME with default settings, with a "data-rich" scenario including 20 years of length, catch, and abundance index data.
```{r, results="hide", warning=FALSE}
res_rich <- run_LIME(modpath=NULL,
                     lh=lh,
                     input_data=data_list,
                     est_sigma="log_sigma_R",
                     data_avail="Index_Catch_LC",
                     C_opt=2)
```

Let's compare results from the data-rich scenario when we exclude catch data by changing the `data_avail` argument:
```{r, results="hide", warning=FALSE}
res_nocatch <- run_LIME(modpath=NULL,
                        lh=lh,
                        input_data=data_list,
                        est_sigma="log_sigma_R",
                        data_avail="Index_LC")
```


Now let's run LIME with length data only:
```{r, results="hide", warning=FALSE}
res_length <- run_LIME(modpath=NULL,
                       lh=lh,
                       input_data=data_list,
                       est_sigma="log_sigma_R",
                       data_avail="LC")
```

Finally, let's run LIME with only 10 years of length data, but continue modeling 20 years:
```{r, results="hide", warning=FALSE}

## new data list
data_list_short <- list("years"=total_years, "LF"=LF_short)

res_length_short <- run_LIME(modpath=NULL,
                       lh=lh,
                       input_data=data_list_short,
                       est_sigma="log_sigma_R",
                       data_avail="LC")
```




## Check convergence and plot output

All models we ran estimate 20 years of annual fishing mortality (`log_F_t_input`), recruitment standard deviation (`log_sigma_R`), selectivity parameters (`logS50` and `logSdelta`), and the Dirichlet-multinomial theta parameter (`log_theta`). 

Some other parameters are estimated if an abundance index or catch data are included. 

Before we use any of the above output, we need to check the model convergence. We assess model convergence based on if the absolute value of the final gradient of each parameter is less than 0.001. 
```{r, include=FALSE}
colnames(res_rich$df) <- colnames(res_nocatch$df) <- colnames(res_length$df) <- c("Final gradient", "Parameter", "Estimate", "Transformed estimate")
```
Data-rich scenario, includes default estimated parameters as well as catchability coefficient (`log_q_I`) and equilibrium recruitment (`beta`):
```{r}
res_rich$df[,1:2]
```

Index and length scenario, includes default estimated parameters as well as catchability coefficient:
```{r}
res_nocatch$df[,1:2]
```

Length only scenarios (20 years and 10 years), include default estimated parameters only.
```{r}
res_length$df[,1:2]
```

10 years of length:
```{r}
res_length_short$df[,1:2]
```



Once we have confirmed each model has converged, we can explore model output. The black lines indicate the true value of fishing mortality, recruitment, SPR, and selectivity. Blue lines indicate the maximum likelihood estimates, blue points indicate a year with data, and blue shading indicates 95% confidence intervals. 

```{r, warning=FALSE, message=FALSE, fig.cap="Results from data-rich scenario"}
plot_output(all_years=total_years, true_years=total_years, lc_years=length_years, Inputs=res_rich$Inputs, Report=res_rich$Report, Sdreport=res_rich$Sdreport, lh=lh, True=true, plot=c("Fish","Rec","SPR","Selex"))
```

```{r, warning=FALSE, message=FALSE, fig.cap="Results from including index and length"}
plot_output(all_years=total_years, true_years=total_years, lc_years=length_years, Inputs=res_nocatch$Inputs, Report=res_nocatch$Report, Sdreport=res_nocatch$Sdreport, lh=lh, True=true, plot=c("Fish","Rec","SPR","Selex"))
```

```{r, warning=FALSE, message=FALSE, fig.cap="Results including length only"}
plot_output(all_years=total_years, true_years=total_years, lc_years=length_years, Inputs=res_length$Inputs, Report=res_length$Report, Sdreport=res_length$Sdreport, lh=lh, True=true, plot=c("Fish","Rec","SPR","Selex"))
```

```{r, warning=FALSE, message=FALSE, fig.cap="Results including 10 years of length data only"}
plot_output(all_years=total_years, true_years=total_years, lc_years=11:20, Inputs=res_length_short$Inputs, Report=res_length_short$Report, Sdreport=res_length_short$Sdreport, lh=lh, True=true, plot=c("Fish","Rec","SPR","Selex"))
```


## Check sensitivites

**Biological inputs**

The most straightforward way to test LIME sensitivity to input parameters is to create alternate life history/input lists using `create_lh_list`. For example, if we want to test the impact of a 25% larger asympototic length, we could create a new list:

```{r}
lh_alt <- create_lh_list(vbk=0.21,
                     linf=65*1.25,
                     t0=-0.01,
                     lwa=0.0245,
                     lwb=2.79,
                     M=0.27,
                     M50=34,
                     M95=NULL,
                     maturity_input="length",
                     S50=20,
                     S95=26,
                     selex_input="length",
                     binwidth=1,
                     CVlen=0.1,
                     SigmaR=0.737,
                     SigmaF=0.2,
                     R0=1,
                     rho=0.43,
                     nseasons=1)
```

Then re-run the assessment with the new life history list, for example with length data only:

```{r, results="hide", warning=FALSE}
res_alt <- run_LIME(modpath=NULL,
                    lh=lh_alt,
                    input_data=data_list,
                    est_sigma="log_sigma_R",
                    data_avail="LC")
```

Then check how the larger asymptotic length impacts the assessment results:
```{r}
plot_output(all_years=total_years, true_years=total_years, lc_years=length_years, Inputs=res_length$Inputs, Report=res_length$Report, Sdreport=res_length$Sdreport, lh=lh, True=true, plot=c("Fish","Rec", "SPR","Selex"))
plot_output(all_years=total_years, true_years=total_years, lc_years=length_years, Inputs=res_alt$Inputs, Report=res_alt$Report, Sdreport=res_alt$Sdreport, lh=lh_alt, True=true, plot=c("Fish", "Rec", "SPR", "Selex"))
```


**Selectivity model**

Users may also want to fix the selectivity curve, either based on previous studies or to examine the impact of dome-shaped selectivity. Here is an example where we create an input list with an assumed function for dome-shaped selectivity:

```{r}
lh_dome <- create_lh_list(vbk=0.21,
                     linf=65,
                     t0=-0.01,
                     lwa=0.0245,
                     lwb=2.79,
                     M=0.27,
                     M50=34,
                     M95=NULL,
                     maturity_input="length",
                     S50=20,
                     S95=26,
                     selex_input="length",
                     selex_type="dome",
                     dome_sd=15,
                     binwidth=1,
                     CVlen=0.1,
                     SigmaR=0.737,
                     SigmaF=0.2,
                     R0=1,
                     rho=0.43,
                     nseasons=1)
```

```{r, echo=FALSE}
par(mfrow=c(1,1))
plot(lh$S_l, lwd=4, type="l", xlab="Length (cm)", ylab="Proportion selected to gear", xaxs="i", yaxs="i", cex.lab=1.5, cex.axis=1.5, xpd=NA)
lines(lh_dome$S_l, col="red", lwd=4, lty=2)
legend("bottomright", lwd=2, lty=c(1,2), col=c("black","red"), legend=c("Logistic","Dome"), title="Selectivity model")
```

Then use the `S_l_input` argument to re-run the assessment with the fixed dome-shaped selectivity curve. This assessment will not estimate selectivity parameters.

```{r, results="hide", warning=FALSE}
res_dome <- run_LIME(modpath=NULL,
                    lh=lh,
                    input_data=data_list,
                    est_sigma="log_sigma_R",
                    data_avail="LC",
                    S_l_input=lh_dome$S_l)
```

Then check how the assumed dome-shaped selectivity curve impacts assessment results:
```{r}
plot_output(all_years=total_years, true_years=total_years, lc_years=length_years, Inputs=res_length$Inputs, Report=res_length$Report, Sdreport=res_length$Sdreport, lh=lh, True=true, plot=c("Fish", "Rec","SPR", "Selex"))
plot_output(all_years=total_years, true_years=total_years, lc_years=length_years, Inputs=res_dome$Inputs, Report=res_dome$Report, Sdreport=res_dome$Sdreport, lh=lh_dome, True=true, plot=c("Fish","Rec", "SPR","Selex"))
```



# References

Kristensen, K., Nielsen, A., Berg, C.W., Skaug, H., and Bell, B. 2016. TMB: Automatic Differentiation and Laplace Approximation. Journal of Statistical Software. 

Rudd, M.B. and Thorson, J.T. 2017. Accounting for variable recruitment and fishing mortality in length-based stock assessments for data-limited fisheries. Canadian Journal of Fisheries and Aquatic Sciences. https://doi.org/10.1139/cjfas-2017-0143

Thorson, J.T., Jensen, O.P, and Zipkin, E.F. 2014. How variable is recruitment for exploited marine fishes? A hierarchical model for testing life history theory. Canadian Journal of Fisheries and Aquatic Sciences 71(7):973-983.

Thorson, J.T. Johnson, K.F., Methot, R.D., and Taylor, I.G. 2017. Model-based estimates of effective sample size in stock assessment models using the Dirichlet-multinomial distribution. Fisheries Research 192:84-93.